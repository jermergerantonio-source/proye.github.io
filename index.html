<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Gasto Innecesario de Agua</title>
  <link rel="stylesheet" href="css.css">
  <script src="datos.js"></script>
  <script src="clasificador.js"></script>
</head>
<body>

<div class="header-app">
  <div class="container">
    <h1 style="display: inline-block;">Calculadora de gasto innecesario de agua</h1>
    <div class="header-buttons">
      <button onclick="irAlPerfil()" class="btn-perfil">Mi Perfil</button>
      <button onclick="cerrarSesion()" class="btn-logout">Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<div class="app-wrapper">
<div class="container">
  <!--SELECTOR DE PRODUCTO-->
  <div class="seccion">
    <div class="seccion-titulo">Selector de Producto</div>
    <div class="seccion-contenido">
      <p>Selecciona un objeto de uso cotidiano para conocer su impacto en el consumo de agua:</p>

      <select id="producto">
      <option value="">Selecciona un objeto</option>

      <optgroup label="Bebidas y electr√≥nica">
        <option value="refresco">Refresco (1 L)</option>
        <option value="lata">Refresco en lata</option>
        <option value="agua">Agua embotellada (1 L)</option>
        <option value="cafe">Caf√© preparado</option>
        <option value="energia">Bebida energ√©tica</option>
        <option value="cerveza">Cerveza</option>
        <option value="cable">Cable USB</option>
        <option value="audifonos">Aud√≠fonos</option>
        <option value="cargador">Cargador de celular</option>
        <option value="powerbank">Power bank</option>
        <option value="celular">Celular nuevo</option>
        <option value="tablet">Tablet</option>
        <option value="laptop">Laptop</option>
        <option value="monitor">Monitor</option>
        <option value="consola">Consola de videojuegos</option>
      </optgroup>

      <optgroup label="√ötiles escolares">
        <option value="lapiz">L√°piz</option>
        <option value="pluma">Pluma</option>
    <option value="marcador">Marcador</option>
    <option value="libreta">Libreta</option>
    <option value="cuaderno">Cuaderno</option>
    <option value="hoja">Hoja de papel</option>
    <option value="paquete">Paquete de hojas</option>
    <option value="folder">Folder</option>
    <option value="carpeta">Carpeta</option>
    <option value="mochila">Mochila</option>
    <option value="calculadora">Calculadora</option>
    <option value="cartucho">Cartucho de tinta</option>
    <option value="toner">T√≥ner</option>
    <option value="libro">Libro impreso</option>
  </optgroup>

  <optgroup label="Ropa y textiles">
    <option value="playera">Playera</option>
    <option value="camisa">Camisa</option>
    <option value="sudadera">Sudadera</option>
    <option value="jeans">Jeans</option>
    <option value="vestido">Vestido</option>
    <option value="ropaInterior">Ropa interior</option>
    <option value="calcetines">Calcetines</option>
    <option value="tenis">Tenis</option>
    <option value="chamarra">Chamarra</option>
    <option value="toalla">Toalla</option>
    <option value="sabana">S√°bana</option>
    <option value="cobija">Cobija</option>
    <option value="uniforme">Uniforme escolar</option>
    <option value="traje">Traje</option>
  </optgroup>
</select>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button onclick="agregarAlCarrito()" class="btn-calcular" style="flex: 1;">Agregar a la lista (+)</button>
      </div>

      <!-- Lista de productos agregados -->
      <div id="lista-carrito" style="margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 10px;">
        <p style="color: #888; font-style: italic; font-size: 0.9em; text-align: center;">Tu lista est√° vac√≠a</p>
      </div>

      <button onclick="calcularTotal()" id="btn-calcular-total" class="btn-calcular" style="margin-top: 15px; width: 100%; display: none; background-color: #2d3748;">Calcular Impacto Total</button>
    </div>
  </div>

  <!--SECCI√ìN:RESULTADOS-->
  <div class="seccion">
    <div class="seccion-titulo">Resultado</div>
    <div class="seccion-contenido">
      <div class="resultado" id="resultado">
        <p style="color: #999; text-align: center; margin: 20px 0;">Selecciona un producto y haz clic en "Calcular" para ver los resultados</p>
      </div>
    </div>
  </div>
</div>
</div>

<script>
//Verificar sesi√≥n
let carrito = [];

window.addEventListener('DOMContentLoaded', function() {
  const sesionActiva = localStorage.getItem('usuarioActivo');
  if (!sesionActiva) {
    window.location.href = 'login.html';
    return;
  }
});

function agregarAlCarrito() {
  const select = document.getElementById("producto");
  const productoKey = select.value;
  
  if (!productoKey) {
    alert("Por favor selecciona un producto primero");
    return;
  }

  const nombre = select.options[select.selectedIndex].text;
  const litros = datos[productoKey];

  carrito.push({
    key: productoKey,
    nombre: nombre,
    litros: litros
  });

  actualizarVistaCarrito();
  select.value = ""; // Resetear selecci√≥n
}

function eliminarDelCarrito(index) {
  carrito.splice(index, 1);
  actualizarVistaCarrito();
}

function actualizarVistaCarrito() {
  const container = document.getElementById("lista-carrito");
  const btnCalcular = document.getElementById("btn-calcular-total");

  if (carrito.length === 0) {
    container.innerHTML = '<p style="color: #888; font-style: italic; font-size: 0.9em; text-align: center;">Tu lista est√° vac√≠a</p>';
    btnCalcular.style.display = 'none';
    document.getElementById("resultado").innerHTML = '<p style="color: #999; text-align: center; margin: 20px 0;">Selecciona productos y agr√©galos a la lista para calcular</p>';
    return;
  }

  let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
  carrito.forEach((item, index) => {
    html += `
      <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05);">
        <span>${item.nombre}</span>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-weight: bold; font-size: 0.9em;">${item.litros.toLocaleString()} L</span>
          <button onclick="eliminarDelCarrito(${index})" style="background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
        </div>
      </li>
    `;
  });
  html += '</ul>';
  
  container.innerHTML = html;
  btnCalcular.style.display = 'block';
}

function calcularTotal() {
  if (carrito.length === 0) return;

  let totalLitros = 0;
  let htmlDetalles = '';

  // Procesar cada item
  carrito.forEach(item => {
    totalLitros += item.litros;
    
    // Clasificar individualmente para el reporte y el historial
    const clasificacion = clasificarObjeto(item.key, item.litros);
    registrarBusqueda(item.key, item.litros, clasificacion);

    // Color seg√∫n categor√≠a
    const categoriaColor = {
      'consumo innecesario': '#ff6b6b',
      'uso moderado': '#ffd93d',
      'uso responsable': '#6bcf7f'
    };
    const color = categoriaColor[clasificacion.categoria] || '#667eea';

    // Tip inteligente (si existe en clasificador.js)
    const tip = (typeof alternativasEco !== 'undefined' && alternativasEco[item.key]) 
      ? `<br><small style="color: #2ecc71; display:block; margin-top:4px;">üí° <strong>Tip:</strong> ${alternativasEco[item.key]}</small>` 
      : '';

    // Explicaci√≥n del "Por qu√©"
    const razon = `Este objeto tiene un impacto h√≠drico <strong>${clasificacion.impacto.toUpperCase()}</strong> y se considera de necesidad <strong>${clasificacion.necesidad.toUpperCase()}</strong>.`;

    htmlDetalles += `
      <div style="margin-bottom: 12px; padding: 10px; border-left: 4px solid ${color}; background: rgba(0,0,0,0.02);">
        <div style="display:flex; justify-content:space-between;">
          <strong>${item.nombre}</strong>
          <span style="color:${color}; font-weight:bold;">${item.litros.toLocaleString()} L</span>
        </div>
        <small style="color: #666;">${clasificacion.categoria.toUpperCase()}</small>
        ${tip}
        
        <details style="margin-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 8px;">
          <summary style="cursor: pointer; font-size: 0.9em; font-weight: bold; opacity: 0.8;">‚ùì Ver detalles y explicaci√≥n</summary>
          <div style="margin-top: 8px; font-size: 0.9em; padding-left: 10px; border-left: 2px solid rgba(0,0,0,0.1);">
            <p style="margin: 4px 0;">${razon}</p>
            <hr style="border: 0; border-top: 1px dashed rgba(0,0,0,0.1); margin: 8px 0;">
            <p style="margin: 4px 0; line-height: 1.4;">${clasificacion.explicacion.replace(/\n/g, '<br>')}</p>
          </div>
        </details>
      </div>
    `;
  });

  // Resumen Total
  const minutosDucha = totalLitros / 10;
  
  let htmlResultado = `
    <div style="text-align: center; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(102, 126, 234, 0.3);">
      <h2 style="margin: 0 0 10px 0; color: #5a67d8;">Impacto Total</h2>
      <div style="font-size: 2.5em; font-weight: bold; color: #2d3748; margin-bottom: 10px;">
        ${totalLitros.toLocaleString()} <span style="font-size: 0.4em; color: #718096;">litros de agua</span>
      </div>
      <p style="margin: 0; color: #4a5568;">
        Equivale a dejar la ducha abierta por <strong>${minutosDucha.toFixed(0)} minutos</strong>.
      </p>
    </div>
    
    <h4 style="border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">Desglose de tu lista:</h4>
    ${htmlDetalles}
    
    <button onclick="limpiarCarrito()" class="btn-calcular" style="margin-top: 20px; background-color: #718096;">Limpiar y empezar de nuevo</button>
  `;

  document.getElementById("resultado").innerHTML = htmlResultado;
}

function limpiarCarrito() {
  carrito = [];
  actualizarVistaCarrito();
}

function registrarBusqueda(producto, litros, clasificacion) {
  const usuario = JSON.parse(localStorage.getItem('usuarioActivo'));
  let usuarioData = JSON.parse(localStorage.getItem('usuarioData_' + usuario.username));
  
  if (!usuarioData) {
    usuarioData = {
      username: usuario.username,
      fotoPerfil: null,
      fechaRegistro: new Date().toLocaleString(),
      historial: [],
      estadisticas: {
        totalBusquedas: 0,
        productosConteo: {},
        totalLitros: 0
      }
    };
  }
  
  //Actualizar estad√≠sticas
  usuarioData.estadisticas.totalBusquedas++;
  usuarioData.estadisticas.totalLitros += litros;
  
  if (!usuarioData.estadisticas.productosConteo[producto]) {
    usuarioData.estadisticas.productosConteo[producto] = 0;
  }
  usuarioData.estadisticas.productosConteo[producto]++;
  
  //Agregar al historial
  usuarioData.historial.push({
    producto: producto,
    litros: litros,
    categoria: clasificacion.categoria,
    necesidad: clasificacion.necesidad,
    fecha: new Date().toLocaleString()
  });
  
  localStorage.setItem('usuarioData_' + usuario.username, JSON.stringify(usuarioData));
}

function irAlPerfil() {
  window.location.href = 'perfil.html';
}

function cerrarSesion() {
  if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
    localStorage.removeItem('usuarioActivo');
    window.location.href = 'login.html';
  }
}
</script>
<script src="theme.js"></script>

</body>
</html>

